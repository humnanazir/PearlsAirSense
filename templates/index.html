<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pearls AQI Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #ffe4ec, #ffc1d6);
      margin: 0;
      padding: 0;
      color: #333;
    }
    header { color: #c2185b; text-align: left; font-size: 32px; font-weight: 700; padding: 25px 50px; letter-spacing: 1px; }
    .container { background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); width: 110%; max-width: 1300px; margin: 30px auto; border-radius: 20px; padding: 35px; box-shadow: 0 8px 25px rgba(255,105,180,0.3); }
    .top { display: flex; justify-content: space-between; align-items: center; }
    .aqi-number { font-size: 70px; color: #d81b60; font-weight: 700; }
    .aqi-status { font-size: 22px; font-weight: 600; color: white; background-color: #d81b60; border-radius: 25px; padding: 8px 20px; text-transform: capitalize; }
    .scale { margin: 30px 0; }
    .scale-labels { display: flex; justify-content: space-between; font-size: 14px; color: #555; margin-bottom: 8px; }
    .scale-bar { height: 12px; border-radius: 6px; background: linear-gradient(to right,#8bc34a 0%,#ffeb3b 20%,#ff9800 40%,#e53935 60%,#8e24aa 80%,#6a1b9a 100%); position: relative; }
    .marker { position: absolute; width: 18px; height: 18px; border-radius: 50%; background-color: #d81b60; top: -3px; transition: left 0.6s ease-in-out; box-shadow: 0 0 8px rgba(216,27,96,0.5); }
    .data-details { display: flex; justify-content: space-around; background: white; border-radius: 15px; padding: 20px; margin-top: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .data-details div { text-align: center; font-size: 15px; font-weight: 500; }
    .chart-container { background: white; border-radius: 15px; margin-top: 35px; padding: 25px; box-shadow: 0 4px 15px rgba(216,27,96,0.15); }
    #aqiMap { width: 100%; height: 500px; border-radius: 50px; }
    
    /* Forecast cards outside main container */
    .forecast-container { 
      display: flex; 
      justify-content: space-around; 
      margin: 30px 50px; 
      flex-wrap: wrap; /* responsive for smaller screens */
      gap: 20px;
    }

    .forecast-card { 
      padding: 50px; 
      border-radius: 50px; 
      width: 100%; 
      min-width: 220px; 
      text-align: center; 
      box-shadow: 0 8px 20px rgba(216,27,96,0.15); 
      font-weight: 500; 
      border: 2px solid rgba(255,105,180,0.3); 
      transition: transform 0.3s, box-shadow 0.3s; 
    }

    .forecast-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(216,27,96,0.25);
    }

    /* Pastel colors complementing light pink background */
    #day1 { background-color: #d2f097; } 
    #day2 { background-color: #98d2f9; } 
    #day3 { background-color: #eddc9d; } 

    /* Plots container */
    .plots-container {
      display: flex;
      justify-content: center; /* center horizontally */
      align-items: flex-start; /* align top edges */
      gap: 40px; /* space between the plots */
      flex-wrap: wrap; /* wrap on small screens */
      margin: 40px 0;
    }

    .plot-card {
      background: rgba(255, 255, 255, 0.85);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(216,27,96,0.15);
      text-align: center;
      max-width: 600px;
      width: 100%;
    }

    .plot-card img {
      width: 100%;
      height: auto;
      border-radius: 15px;
    }

  </style>
</head>
<body>
  <header>ðŸŒ¸ Pearls AQI Dashboard</header>

  <div class="container">
    <div class="top">
      <div>
        <h3>Live AQI</h3>
        <div class="aqi-number" id="aqiValue">--</div>
      </div>
      <div class="aqi-status" id="aqiStatus">Loading...</div>
    </div>

    <div class="scale">
      <div class="scale-labels">
        <span>Good</span>
        <span>Moderate</span>
        <span>Poor</span>
        <span>Unhealthy</span>
        <span>Severe</span>
        <span>Hazardous</span>
      </div>
      <div class="scale-bar">
        <div class="marker" id="marker"></div>
      </div>
    </div>

    <div class="data-details">
      <div><b>PM10</b><br><span id="pm10">--</span> Âµg/mÂ³</div>
      <div><b>PM2.5</b><br><span id="pm25">--</span> Âµg/mÂ³</div>
      <div><b>Temp</b><br><span id="temp">--</span> Â°C</div>
      <div><b>Humidity</b><br><span id="humidity">--</span> %</div>
      <div><b>Wind</b><br><span id="wind">--</span> km/h</div>
    </div>

    <div class="chart-container">
      <h3 style="color:#c2185b; text-align:center;">AQI Trend (Past 24 Hours)</h3>
      <canvas id="aqiChart" width="400" height="200"></canvas>
    </div>

    <div class="map-container">
      <h3 style="color:#c2185b; text-align:center;">Nearby AQI Stations</h3>
      <div id="aqiMap"></div>
    </div>
  </div>

  <h1 style="text-align:center; color:#c2185b; margin-top:40px;">3-Day AQI Forecast (Random Forest Prediction)</h1>
  <!-- Forecast + Robot Section -->
  <div class="forecast-container">
    <div class="forecast-card" id="day1">
      <h1>Day 1</h1>
      <p>Random Forest AQI: <span id="day1-rf">--</span></p>
      <p>PM2.5: <span id="day1-pm25">--</span></p>
      <p>PM10: <span id="day1-pm10">--</span></p>
    </div>
    <div class="forecast-card" id="day2">
      <h1>Day 2</h1>
      <p>Random Forest AQI: <span id="day2-rf">--</span></p>
      <p>PM2.5: <span id="day2-pm25">--</span></p>
      <p>PM10: <span id="day2-pm10">--</span></p>
    </div>
    <div class="forecast-card" id="day3">
      <h1>Day 3</h1>
      <p>Random Forest AQI: <span id="day3-rf">--</span></p>
      <p>PM2.5: <span id="day3-pm25">--</span></p>
      <p>PM10: <span id="day3-pm10">--</span></p>
    </div>
  </div>

  <!-- Plots Section -->
  <div class="plots-container">
    <div class="plot-card">
      <h2>AQI Trend (Last 50 Records)</h2>
      <img src="data:image/png;base64,{{ eda_plot_url }}" alt="EDA Plot">
    </div>
    <div class="plot-card">
      <h2>Feature Importance</h2>
      <img src="data:image/png;base64,{{ fi_plot_url }}" alt="Feature Importance Plot">
    </div>
  </div>

  <script>
let aqiChart;

// Update marker position on scale
function updateMarker(aqi) {
    const marker = document.getElementById("marker");
    let percent = 0;
    if (aqi <= 50) percent = (aqi / 50) * 20;
    else if (aqi <= 100) percent = 20 + ((aqi - 50) / 50) * 20;
    else if (aqi <= 150) percent = 40 + ((aqi - 100) / 50) * 20;
    else if (aqi <= 200) percent = 60 + ((aqi - 150) / 50) * 20;
    else if (aqi <= 300) percent = 80 + ((aqi - 200) / 100) * 20;
    else percent = 100;
    marker.style.left = `calc(${percent}% - 9px)`;
}

async function updateDashboard() {
  try {
    const pastRes = await fetch("/past24");
    const pastData = await pastRes.json();
    const labels = pastData.time;
    const aqiData = pastData.aqi;
    const lastAQI = aqiData[aqiData.length - 1];
    document.getElementById("aqiValue").textContent = lastAQI.toFixed(0);

    let status="Good", color="#8bc34a";
    if(lastAQI <=50){status="Good"; color="#8bc34a";}
    else if(lastAQI<=100){status="Moderate"; color="#ffeb3b";}
    else if(lastAQI<=150){status="Poor"; color="#ff9800";}
    else if(lastAQI<=200){status="Unhealthy"; color="#e53935";}
    else if(lastAQI<=300){status="Severe"; color="#8e24aa";}
    else{status="Hazardous"; color="#6a1b9a";}

    document.getElementById("aqiStatus").textContent=status;
    document.getElementById("aqiStatus").style.backgroundColor=color;
    updateMarker(lastAQI);

    const ctx = document.getElementById("aqiChart").getContext("2d");
    if(aqiChart){
      aqiChart.data.labels=labels;
      aqiChart.data.datasets[0].data=aqiData;
      aqiChart.update();
    }else{
      aqiChart=new Chart(ctx,{
        type:'line',
        data:{
          labels:labels,
          datasets:[{
            label:"AQI (Last 24 Hours)",
            data:aqiData,
            borderColor:"#d81b60",
            backgroundColor:"rgba(216,27,96,0.25)",
            borderWidth:2,
            tension:0.3,
            fill:true,
            pointRadius:3
          }]
        },
        options:{scales:{x:{title:{display:true,text:"Time"}},y:{title:{display:true,text:"AQI"}}}}
      });
    }

    const latestRes = await fetch("/latest");
    const latest = await latestRes.json();
    document.getElementById("pm10").textContent=latest.pm10.toFixed(1);
    document.getElementById("pm25").textContent=latest.pm25.toFixed(1);
    document.getElementById("temp").textContent=latest.temp.toFixed(1);
    document.getElementById("humidity").textContent=latest.humidity.toFixed(1);
    document.getElementById("wind").textContent=latest.wind.toFixed(1);
  }catch(err){
    console.error("Error updating dashboard:", err);
  }
}

// -------------------- Leaflet Map --------------------
const map = L.map('aqiMap').setView([24.8607, 67.0011], 11); // Default center
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
const markers = L.layerGroup().addTo(map);

async function updateMap(){
  try{
    const res = await fetch("/stations");
    const data = await res.json();
    markers.clearLayers();
    data.forEach(station=>{
      const color = getAQIColor(station.aqi);
      const marker = L.circleMarker([station.lat,station.lon],{
        radius:10,
        fillColor: color,
        color:"#000",
        weight:1,
        opacity:1,
        fillOpacity:0.8
      }).bindPopup(`<b>${station.name}</b><br>AQI: ${station.aqi}`);
      markers.addLayer(marker);
    });

  }catch(err){console.error("Error fetching stations:",err);}
}

function getAQIColor(aqi){
  if(aqi<=50) return "#8bc34a";
  else if(aqi<=100) return "#ffeb3b";
  else if(aqi<=150) return "#ff9800";
  else if(aqi<=200) return "#e53935";
  else if(aqi<=300) return "#8e24aa";
  else return "#6a1b9a";
}

// -------------------- 3-Day Forecast --------------------
async function updateForecast() {
  try {
    const res = await fetch("/forecast");
    const data = await res.json();

    console.log("Forecast data:", data); // check browser console

    if (data.error) {
      console.error("Server Error:", data.error);
      return;
    }

    for (let i = 0; i < 3; i++) {
  document.getElementById(`day${i+1}-rf`).textContent = data.aqi[i]; // use aqi from server
  document.getElementById(`day${i+1}-pm25`).textContent = data.pm25[i];
  document.getElementById(`day${i+1}-pm10`).textContent = data.pm10[i];
}
  } catch (err) {
    console.error("Error fetching forecast:", err);
  }
}

window.onload = updateForecast;


window.onload = updateForecast;


// Initial load
updateDashboard();
setInterval(updateDashboard, 20000);
updateMap();
setInterval(updateMap,300000);
updateForecast();
setInterval(updateForecast, 3600000); // refresh every 1 hour



  </script>

  
</body>
</html>
